{% extends 'base.html' %}

{% block title %}{{ session.title }} â€” agextract{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8 pt-4">

    <!-- Session Header -->
    <div class="bg-gray-800/40 backdrop-blur border border-gray-700/50 rounded-2xl p-8">
        <div class="flex items-start justify-between mb-6">
            <div class="flex-1 min-w-0">
                {% if session.user %}
                <a href="{% url 'public_profile' username=session.user.username %}"
                   class="inline-flex items-center text-sm text-gray-400 hover:text-brand-accent transition-colors mb-3">
                    <span class="w-6 h-6 rounded-md bg-gradient-to-br from-brand-accent to-blue-600 flex items-center justify-center text-xs font-bold text-white mr-2">{{ session.user.username.0|upper }}</span>
                    @{{ session.user.username }}
                </a>
                {% endif %}
                <h1 class="text-3xl font-bold text-white leading-tight">{{ session.title }}</h1>
                {% if session.summary %}
                <p class="text-gray-400 mt-2 text-lg">{{ session.summary }}</p>
                {% endif %}
            </div>
            <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-xs font-semibold flex-shrink-0 ml-4
                {% if session.source == 'claudecode' %}bg-orange-500/10 text-orange-300 border border-orange-500/20
                {% elif session.source == 'cursor' %}bg-purple-500/10 text-purple-300 border border-purple-500/20
                {% elif session.source == 'windsurf' %}bg-green-500/10 text-green-300 border border-green-500/20
                {% elif session.source == 'copilot' %}bg-blue-500/10 text-blue-300 border border-blue-500/20
                {% else %}bg-gray-700/50 text-gray-300 border border-gray-600/30{% endif %}">
                {{ session.get_source_display }}
            </span>
        </div>

        <!-- Session Stats -->
        <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
            <div class="bg-gray-900/40 rounded-lg px-3 py-2 text-center">
                <div class="text-lg font-bold text-white">{{ total_steps }}</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider">Steps</div>
            </div>
            <div class="bg-gray-900/40 rounded-lg px-3 py-2 text-center">
                <div class="text-lg font-bold text-brand-accent">{{ user_count }}</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider">Human</div>
            </div>
            <div class="bg-gray-900/40 rounded-lg px-3 py-2 text-center">
                <div class="text-lg font-bold text-gray-400">{{ agent_count }}</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider">AI</div>
            </div>
            <div class="bg-gray-900/40 rounded-lg px-3 py-2 text-center">
                <div class="text-lg font-bold text-purple-400">{{ tool_count }}</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider">Tools</div>
            </div>
            <div class="bg-gray-900/40 rounded-lg px-3 py-2 text-center">
                <div class="text-lg font-bold text-amber-400">{{ tag_count }}</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider">Tags</div>
            </div>
            <div class="bg-gray-900/40 rounded-lg px-3 py-2 text-center">
                <div class="text-lg font-bold text-emerald-400">{{ steering_ratio }}%</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider">Steering</div>
            </div>
        </div>
    </div>

    <!-- Conversation Flow Chart -->
    {% if total_steps > 0 %}
    <div class="bg-gray-800/40 backdrop-blur border border-gray-700/50 rounded-2xl p-6">
        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">Conversation Flow</h3>
        <div style="height: 200px;">
            <canvas id="conversationFlowChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="flex items-center space-x-2">
        <span class="text-xs text-gray-500 uppercase tracking-wider mr-2">Filter:</span>
        <button onclick="filterSteps('all')" data-filter="all"
            class="filter-btn active-filter px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 text-white border border-gray-600 hover:border-gray-500 transition-colors">
            All
        </button>
        <button onclick="filterSteps('user')" data-filter="user"
            class="filter-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800/50 text-brand-accent border border-brand-accent/20 hover:border-brand-accent/50 transition-colors">
            Human
        </button>
        <button onclick="filterSteps('agent')" data-filter="agent"
            class="filter-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800/50 text-purple-400 border border-purple-500/20 hover:border-purple-500/50 transition-colors">
            AI
        </button>
        <button onclick="filterSteps('tool_call')" data-filter="tool_call"
            class="filter-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800/50 text-amber-400 border border-amber-500/20 hover:border-amber-500/50 transition-colors">
            Tool Calls
        </button>
    </div>

    <!-- Conversation Thread -->
    <div class="space-y-1" id="steps-container">
        {% for step in steps %}
        <div class="step-item step-role-{{ step.role }} step-type-{{ step.step_type }} group"
             data-role="{{ step.role }}" data-type="{{ step.step_type }}">

            {% if step.role == 'user' %}
            <!-- Human Input -->
            <div class="flex items-start space-x-3 py-4 px-4 rounded-xl hover:bg-brand-accent/5 transition-colors border-l-2 border-brand-accent/40">
                <div class="flex-shrink-0 w-7 h-7 rounded-lg bg-brand-accent/20 flex items-center justify-center mt-0.5">
                    <svg class="w-4 h-4 text-brand-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xs font-semibold text-brand-accent uppercase tracking-wide">Human</span>
                        <span class="text-xs text-gray-600 font-mono">#{{ step.order }}</span>
                        {% if step.tags.exists %}
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-500/20 text-amber-400 border border-amber-500/30">
                            {{ step.tags.first.get_tag_type_display }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap break-words">{{ step.content|truncatechars:2000 }}</div>
                </div>
                <!-- Tag button -->
                <div id="tags-step-{{ step.id }}" class="flex-shrink-0">
                    {% include "core/partials/step_tags.html" with step=step %}
                </div>
            </div>

            {% elif step.step_type == 'tool_call' %}
            <!-- Tool Call -->
            <div class="flex items-start space-x-3 py-3 px-4 rounded-xl hover:bg-purple-500/5 transition-colors border-l-2 border-purple-500/30">
                <div class="flex-shrink-0 w-7 h-7 rounded-lg bg-purple-500/20 flex items-center justify-center mt-0.5">
                    <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xs font-semibold text-purple-400 uppercase tracking-wide">Tool Call</span>
                        <span class="text-xs text-gray-600 font-mono">#{{ step.order }}</span>
                    </div>
                    <div class="bg-gray-900/60 rounded-lg p-3 border border-gray-800/50">
                        <pre class="text-xs text-gray-400 font-mono leading-relaxed whitespace-pre-wrap break-all overflow-hidden">{{ step.content|truncatechars:1500 }}</pre>
                    </div>
                </div>
            </div>

            {% elif step.step_type == 'diff' %}
            <!-- Code Diff -->
            <div class="flex items-start space-x-3 py-3 px-4 rounded-xl hover:bg-emerald-500/5 transition-colors border-l-2 border-emerald-500/30">
                <div class="flex-shrink-0 w-7 h-7 rounded-lg bg-emerald-500/20 flex items-center justify-center mt-0.5">
                    <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xs font-semibold text-emerald-400 uppercase tracking-wide">Code Change</span>
                        <span class="text-xs text-gray-600 font-mono">#{{ step.order }}</span>
                    </div>
                    <div class="bg-gray-950 rounded-lg p-3 border border-gray-800/50 overflow-x-auto">
                        <pre class="text-xs text-gray-300 font-mono leading-relaxed whitespace-pre-wrap">{{ step.content|truncatechars:2000 }}</pre>
                    </div>
                </div>
            </div>

            {% else %}
            <!-- Agent Text Response -->
            <div class="flex items-start space-x-3 py-3 px-4 rounded-xl hover:bg-gray-800/30 transition-colors border-l-2 border-gray-700/40">
                <div class="flex-shrink-0 w-7 h-7 rounded-lg bg-gray-700/40 flex items-center justify-center mt-0.5">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide">AI Response</span>
                        <span class="text-xs text-gray-600 font-mono">#{{ step.order }}</span>
                        {% if step.tags.exists %}
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-500/20 text-amber-400 border border-amber-500/30">
                            {{ step.tags.first.get_tag_type_display }}
                        </span>
                        {% endif %}
                    </div>
                    <div class="text-gray-400 text-sm leading-relaxed whitespace-pre-wrap break-words">{{ step.content|truncatechars:2000 }}</div>
                </div>
                <div id="tags-step-{{ step.id }}" class="flex-shrink-0">
                    {% include "core/partials/step_tags.html" with step=step %}
                </div>
            </div>
            {% endif %}

        </div>
        {% endfor %}
    </div>

</div>

{% if total_steps > 0 %}
<script>
(function() {
    const flowData = {{ conversation_flow_json|safe }};
    Chart.defaults.color = '#9ca3af';
    Chart.defaults.borderColor = 'rgba(75, 85, 99, 0.3)';

    const ctx = document.getElementById('conversationFlowChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: flowData.map(d => d.chunk),
            datasets: [
                {
                    label: 'Human',
                    data: flowData.map(d => d.user),
                    backgroundColor: '#38bdf8',
                    borderRadius: 2,
                },
                {
                    label: 'AI',
                    data: flowData.map(d => d.agent),
                    backgroundColor: '#6b7280',
                    borderRadius: 2,
                },
                {
                    label: 'Tool Calls',
                    data: flowData.map(d => d.tool),
                    backgroundColor: '#a78bfa',
                    borderRadius: 2,
                },
                {
                    label: 'System',
                    data: flowData.map(d => d.system),
                    backgroundColor: '#475569',
                    borderRadius: 2,
                },
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 16, usePointStyle: true, pointStyleWidth: 8, font: { size: 11 } }
                },
            },
            scales: {
                x: {
                    stacked: true,
                    title: { display: true, text: 'Steps', font: { size: 11 } },
                    ticks: { font: { size: 10 } },
                    grid: { display: false },
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: { stepSize: 1, font: { size: 11 } },
                    grid: { color: 'rgba(75, 85, 99, 0.2)' },
                }
            }
        }
    });
})();
</script>
{% endif %}

<script>
    function filterSteps(filter) {
        const items = document.querySelectorAll('.step-item');
        items.forEach(item => {
            const role = item.dataset.role;
            const type = item.dataset.type;
            if (filter === 'all') {
                item.style.display = '';
            } else if (filter === 'tool_call') {
                item.style.display = type === 'tool_call' ? '' : 'none';
            } else {
                item.style.display = role === filter ? '' : 'none';
            }
        });

        // Update active filter button styling
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active-filter', 'ring-1', 'ring-white/30');
        });
        const activeBtn = document.querySelector(`[data-filter="${filter}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active-filter', 'ring-1', 'ring-white/30');
        }
    }
</script>
{% endblock %}
